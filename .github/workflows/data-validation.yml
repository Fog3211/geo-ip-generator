name: Weekly Data Validation

on:
  schedule:
    # Run every Monday at 03:00 UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      sample_size:
        description: 'Number of IPs to validate'
        required: false
        default: 100
        type: number

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

permissions:
  contents: write

jobs:
  validate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Setup database
      run: |
        # Use existing DB or create a temporary one for validation
        if [ ! -f "prisma/dev.db" ]; then
          export DATABASE_URL="file:./validation.db"
          pnpm run db:push
          pnpm run data:import:territories
          pnpm run data:import:ip2location
        fi

    - name: Run data validation
      env:
        SAMPLE_SIZE: ${{ github.event.inputs.sample_size || '100' }}
      run: |
        echo "Start validating IP data quality..."
        pnpm exec tsx scripts/validate-ip-data.ts $SAMPLE_SIZE

    - name: Check validation results
      id: check_results
      run: |
        if [ -f "data/validation/latest-validation-summary.json" ]; then
          ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json)
          ERROR_COUNT=$(jq -r '.errorCount' data/validation/latest-validation-summary.json)
          
          echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          
          # Mark as attention needed if accuracy < 85%
          if (( $(echo "$ACCURACY < 0.85" | bc -l) )); then
            echo "needs_attention=true" >> $GITHUB_OUTPUT
          else
            echo "needs_attention=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "needs_attention=true" >> $GITHUB_OUTPUT
          echo "accuracy=0" >> $GITHUB_OUTPUT
          echo "error_count=999" >> $GITHUB_OUTPUT
        fi

    - name: Upload validation reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-reports-${{ github.run_number }}
        path: |
          data/validation/
        retention-days: 30

    - name: Commit validation reports
      if: always()
      run: |
        git config --local user.name "GeoIP Data Bot"
        git config --local user.email "bot@geo-ip-generator.local"
        
        if [ -d "data/validation" ]; then
          git add data/validation/latest-validation-summary.json
          
          ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json 2>/dev/null || echo "0")
          TOTAL_SAMPLES=$(jq -r '.summary.totalSamples' data/validation/latest-validation-summary.json 2>/dev/null || echo "0")
          
          git commit -m "chore: update data validation report

          ðŸ“Š Validation Summary:
          - Accuracy: $(echo "scale=1; $ACCURACY * 100" | bc)%
          - Samples: $TOTAL_SAMPLES
          - Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ðŸ¤– Auto-generated by Data Validation" || echo "No changes to commit"
          
          git push origin HEAD:${{ github.ref_name }} || echo "Push failed, but continuing"
        fi

    - name: Create Issue for low accuracy
      if: steps.check_results.outputs.needs_attention == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const accuracy = parseFloat('${{ steps.check_results.outputs.accuracy }}');
          const errorCount = parseInt('${{ steps.check_results.outputs.error_count }}');
          const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          const title = `ðŸš¨ Data Validation Alert: Low Accuracy Detected`;
          
          const body = `# Data Validation Alert

          Accuracy is below the threshold.

          ## Results
          - Accuracy: ${(accuracy * 100).toFixed(1)}%
          - Errors: ${errorCount}
          - Sample size: ${{ github.event.inputs.sample_size || '100' }}

          ## Suggested actions
          - Check the run logs: ${runUrl}
          - Download validation artifacts for details
          - Check upstream data sources and API providers

          _This issue was created automatically by the validation workflow._`;
          
          // Check if there is an existing open issue with the same topic
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['data-validation', 'automated']
          });
          
          const hasOpenValidationIssue = existingIssues.data.some(issue => 
            issue.title.includes('Data Validation Alert')
          );
          
          if (!hasOpenValidationIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['data-validation', 'automated', 'needs-investigation']
            });
          }

    - name: Post success summary
      if: steps.check_results.outputs.needs_attention == 'false'
      run: |
        ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json)
        TOTAL_SAMPLES=$(jq -r '.summary.totalSamples' data/validation/latest-validation-summary.json)
        
        echo "Validation passed"
        echo "Accuracy: $(echo "scale=1; $ACCURACY * 100" | bc)%"
        echo "Samples: $TOTAL_SAMPLES"
        echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"