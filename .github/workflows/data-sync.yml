name: Daily Data Sync

on:
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'Force update even if data is unchanged'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    concurrency:
      group: data-sync-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Setup database
      run: |
        # Create a temporary database for data sync
        export DATABASE_URL="file:./sync.db"
        pnpm run db:push

    - name: Run data synchronization
      env:
        DATABASE_URL: "file:./sync.db"
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
      run: |
        # Run the data sync script (backup/update/rollback included)
        pnpm run sync:data

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet data/; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected in data directory"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Detected changes in data directory"
        fi

    - name: Configure Git
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # Set custom commit author and committer for bot
        git config --local user.name "GeoIP Data Bot"
        # Use GitHub Actions bot noreply email to keep the robot avatar
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        export GIT_AUTHOR_NAME="GeoIP Data Bot"
        export GIT_AUTHOR_EMAIL="41898282+github-actions[bot]@users.noreply.github.com"
        export GIT_COMMITTER_NAME="GeoIP Data Bot"
        export GIT_COMMITTER_EMAIL="41898282+github-actions[bot]@users.noreply.github.com"

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # è·å–å½“å‰æ—¶é—´æˆ³
        TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        
        # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
        git add data/
        
        # Commit changes (explicit author info)
        git commit --author="GeoIP Data Bot <41898282+github-actions[bot]@users.noreply.github.com>" -m "chore: update geo-ip data - ${TIMESTAMP}

        ğŸ“Š Data sync summary:
        - Updated at: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - Territories: $(jq '.metadata.countries' data/combined-geo-ip-data.json)
        - IP ranges: $(jq '.metadata.ipRanges' data/combined-geo-ip-data.json)
        - Data size: $(jq -r '.metadata.dataSize' data/combined-geo-ip-data.json)
        
        ğŸ¤– Auto-generated by GitHub Actions"
        
        # Push to remote using default GITHUB_TOKEN
        git push origin HEAD:${GITHUB_REF_NAME}

    - name: Prepare release metadata
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        DATE_UTC="$(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "DATE_UTC=${DATE_UTC}" >> $GITHUB_ENV
        echo "RELEASE_TAG=data-v$(date '+%Y.%m.%d')-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
        echo "RELEASE_NAME=Data Release $(date '+%Y-%m-%d')" >> $GITHUB_ENV
        COUNTRIES=$(jq '.metadata.countries' data/combined-geo-ip-data.json)
        RANGES=$(jq '.metadata.ipRanges' data/combined-geo-ip-data.json)
        SIZE=$(jq -r '.metadata.dataSize' data/combined-geo-ip-data.json)
        cat > release_body.md << EOF
        ğŸ“Š **Automated Data Release**
        
        Updated at (UTC): ${DATE_UTC}
        Countries/Regions: ${COUNTRIES}
        IP ranges: ${RANGES}
        Data size: ${SIZE}
        
        Downloadable assets:
        - JSON: ./data/combined-geo-ip-data.json
        - Minified JSON: ./data/combined-geo-ip-data.min.json
        - CSV: ./data/combined-geo-ip-data.csv
        - Excel: ./data/combined-geo-ip-data.xlsx
        
        Data sources:
        - Territories: mledoze/countries
        - IP ranges: IP2Location LITE
        
        Generated by GitHub Actions
        EOF

    - name: Create release on major updates
      if: steps.check_changes.outputs.changes == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: ${{ env.RELEASE_NAME }}
        body_path: release_body.md
        draft: false
        prerelease: false

    - name: Upload artifacts
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: geo-ip-data-$(date '+%Y%m%d')
        path: |
          data/combined-geo-ip-data.json
          data/combined-geo-ip-data.min.json
          data/combined-geo-ip-data.csv
          data/combined-geo-ip-data.xlsx
          data/backups/
        retention-days: 30

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå·²è‡ªåŠ¨å›é€€åˆ°å¤‡ä»½ç‰ˆæœ¬"
        echo "ğŸ“§ è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯" 