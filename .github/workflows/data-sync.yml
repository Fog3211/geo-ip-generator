name: Daily Data Sync

on:
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'Force update even if data is unchanged'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9'

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Setup database
      run: |
        # åˆ›å»ºä¸´æ—¶æ•°æ®åº“ç”¨äºæ•°æ®åŒæ­¥
        export DATABASE_URL="file:./sync.db"
        pnpm run db:push

    - name: Run data synchronization
      env:
        DATABASE_URL: "file:./sync.db"
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
      run: |
        # è¿è¡Œæ•°æ®åŒæ­¥è„šæœ¬ï¼ˆåŒ…å«å¤‡ä»½ã€æ›´æ–°ã€å›é€€æœºåˆ¶ï¼‰
        pnpm run sync:data

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet data/; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
        fi

    - name: Configure Git
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # è‡ªå®šä¹‰æäº¤èº«ä»½ï¼ˆä½œè€…ä¸æäº¤è€…ï¼‰
        git config --local user.name "GeoIP Data Bot"
        git config --local user.email "bot@geo-ip-generator.local"
        export GIT_AUTHOR_NAME="GeoIP Data Bot"
        export GIT_AUTHOR_EMAIL="bot@geo-ip-generator.local"
        export GIT_COMMITTER_NAME="GeoIP Data Bot"
        export GIT_COMMITTER_EMAIL="bot@geo-ip-generator.local"

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # è·å–å½“å‰æ—¶é—´æˆ³
        TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        
        # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
        git add data/
        
        # æäº¤å˜æ›´ï¼ˆæ˜¾å¼ä½œè€…ä¿¡æ¯ï¼‰
        git commit --author="GeoIP Data Bot <bot@geo-ip-generator.local>" -m "chore: update geo-ip data - ${TIMESTAMP}

        ğŸ“Š Data sync summary:
        - Updated at: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - Territories: $(jq '.metadata.countries' data/combined-geo-ip-data.json)
        - IP ranges: $(jq '.metadata.ipRanges' data/combined-geo-ip-data.json)
        - Data size: $(jq -r '.metadata.dataSize' data/combined-geo-ip-data.json)
        
        ğŸ¤– Auto-generated by GitHub Actions"
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ˆä½¿ç”¨é»˜è®¤ GITHUB_TOKENï¼‰
        git push origin HEAD:${GITHUB_REF_NAME}

    - name: Create release on major updates
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "data-v$(date '+%Y.%m.%d')"
        release_name: "Data Release $(date '+%Y-%m-%d')"
        body: |
          ğŸ“Š **Automated Data Release**
          
          **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          **å›½å®¶/åœ°åŒºæ•°é‡**: $(jq '.metadata.countries' data/combined-geo-ip-data.json)
          **IPæ®µæ•°é‡**: $(jq '.metadata.ipRanges' data/combined-geo-ip-data.json)
          **æ•°æ®å¤§å°**: $(jq -r '.metadata.dataSize' data/combined-geo-ip-data.json)
          
          **å¯ä¸‹è½½æ–‡ä»¶**:
          - ğŸ“„ [JSONæ ¼å¼](./data/combined-geo-ip-data.json)
          - ğŸ—œï¸ [å‹ç¼©JSON](./data/combined-geo-ip-data.min.json) 
          - ğŸ“‹ [CSVæ ¼å¼](./data/combined-geo-ip-data.csv)
          - ğŸ“Š [Excelæ ¼å¼](./data/combined-geo-ip-data.xlsx)
          
          **æ•°æ®æº**:
          - åœ°åŒºæ•°æ®: [mledoze/countries](https://github.com/mledoze/countries)
          - IPæ•°æ®: [IP2Location LITE](https://lite.ip2location.com/)
          
          ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
        draft: false
        prerelease: false

    - name: Upload artifacts
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: geo-ip-data-$(date '+%Y%m%d')
        path: |
          data/combined-geo-ip-data.json
          data/combined-geo-ip-data.min.json
          data/combined-geo-ip-data.csv
          data/combined-geo-ip-data.xlsx
          data/backups/
        retention-days: 30

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå·²è‡ªåŠ¨å›é€€åˆ°å¤‡ä»½ç‰ˆæœ¬"
        echo "ğŸ“§ è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯" 