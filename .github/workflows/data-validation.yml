name: Data Validation

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 03:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11:00ï¼‰
    - cron: '0 3 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sample_size:
        description: 'Number of IPs to validate'
        required: false
        default: 100
        type: number

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  validate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Setup database
      run: |
        # ä½¿ç”¨ç°æœ‰æ•°æ®åº“æˆ–åˆ›å»ºä¸´æ—¶æ•°æ®åº“
        if [ ! -f "prisma/dev.db" ]; then
          export DATABASE_URL="file:./validation.db"
          pnpm run db:push
          pnpm run import:territories
          pnpm run import:ip2location
        fi

    - name: Run data validation
      env:
        SAMPLE_SIZE: ${{ github.event.inputs.sample_size || '100' }}
      run: |
        echo "ğŸ” å¼€å§‹éªŒè¯IPæ•°æ®è´¨é‡..."
        pnpm run validate:data $SAMPLE_SIZE

    - name: Check validation results
      id: check_results
      run: |
        if [ -f "data/validation/latest-validation-summary.json" ]; then
          ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json)
          ERROR_COUNT=$(jq -r '.errorCount' data/validation/latest-validation-summary.json)
          
          echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æœå‡†ç¡®ç‡ä½äº85%ï¼Œæ ‡è®°ä¸ºéœ€è¦å…³æ³¨
          if (( $(echo "$ACCURACY < 0.85" | bc -l) )); then
            echo "needs_attention=true" >> $GITHUB_OUTPUT
          else
            echo "needs_attention=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "needs_attention=true" >> $GITHUB_OUTPUT
          echo "accuracy=0" >> $GITHUB_OUTPUT
          echo "error_count=999" >> $GITHUB_OUTPUT
        fi

    - name: Upload validation reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: validation-reports-${{ github.run_number }}
        path: |
          data/validation/
        retention-days: 30

    - name: Commit validation reports
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Data Validation Bot"
        
        if [ -d "data/validation" ]; then
          git add data/validation/latest-validation-summary.json
          
          ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json 2>/dev/null || echo "0")
          TOTAL_SAMPLES=$(jq -r '.summary.totalSamples' data/validation/latest-validation-summary.json 2>/dev/null || echo "0")
          
          git commit -m "chore: update data validation report

          ğŸ“Š Validation Summary:
          - Accuracy: $(echo "scale=1; $ACCURACY * 100" | bc)%
          - Samples: $TOTAL_SAMPLES
          - Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ğŸ¤– Auto-generated by Data Validation" || echo "No changes to commit"
          
          git push origin HEAD:${{ github.ref_name }} || echo "Push failed, but continuing"
        fi

    - name: Create Issue for Low Accuracy
      if: steps.check_results.outputs.needs_attention == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const accuracy = parseFloat('${{ steps.check_results.outputs.accuracy }}');
          const errorCount = parseInt('${{ steps.check_results.outputs.error_count }}');
          const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          const title = `ğŸš¨ Data Validation Alert: Low Accuracy Detected`;
          
          const body = `# Data Validation Alert
          
          **âš ï¸ æ•°æ®è´¨é‡è­¦æŠ¥ï¼šæ£€æµ‹åˆ°å‡†ç¡®ç‡åä½**
          
          ## ğŸ“Š éªŒè¯ç»“æœ
          - **å‡†ç¡®ç‡**: ${(accuracy * 100).toFixed(1)}%
          - **é”™è¯¯æ•°é‡**: ${errorCount}
          - **éªŒè¯æ—¶é—´**: $(date)
          - **æ ·æœ¬å¤§å°**: ${{ github.event.inputs.sample_size || '100' }}
          
          ## ğŸ” å¯èƒ½åŸå› 
          1. ç¬¬ä¸‰æ–¹APIè¿”å›äº†ä¸ä¸€è‡´çš„ç»“æœ
          2. æ•°æ®æºæ›´æ–°å¯¼è‡´çš„åœ°åŒºä»£ç å˜åŒ–
          3. IPåœ°å€æ®µåˆ†é…å‘ç”Ÿå˜æ›´
          4. ç½‘ç»œè¿æ¥æˆ–APIé™åˆ¶é—®é¢˜
          
          ## ğŸ“‹ å»ºè®®æ“ä½œ
          - [ ] æ£€æŸ¥éªŒè¯æŠ¥å‘Šè¯¦æƒ…ï¼š[GitHub Actions Run](${runUrl})
          - [ ] ä¸‹è½½å®Œæ•´çš„éªŒè¯æ—¥å¿—è¿›è¡Œåˆ†æ
          - [ ] æ£€æŸ¥æ•°æ®æºæ˜¯å¦æœ‰æ›´æ–°
          - [ ] éªŒè¯ç¬¬ä¸‰æ–¹APIæœåŠ¡çŠ¶æ€
          - [ ] è€ƒè™‘æ›´æ–°IPæ•°æ®åº“
          
          ## ğŸ“ ç›¸å…³æ–‡ä»¶
          - éªŒè¯æŠ¥å‘Šå°†ä½œä¸ºå·¥ä½œæµé™„ä»¶æä¾›
          - é”™è¯¯è¯¦æƒ…ä¿å­˜åœ¨ \`data/validation/\` ç›®å½•
          
          **æ­¤é—®é¢˜ç”±æ•°æ®éªŒè¯å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚**`;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„å¼€æ”¾issue
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['data-validation', 'automated']
          });
          
          const hasOpenValidationIssue = existingIssues.data.some(issue => 
            issue.title.includes('Data Validation Alert')
          );
          
          if (!hasOpenValidationIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['data-validation', 'automated', 'needs-investigation']
            });
          }

    - name: Post Success Summary
      if: steps.check_results.outputs.needs_attention == 'false'
      run: |
        ACCURACY=$(jq -r '.summary.accuracyRate' data/validation/latest-validation-summary.json)
        TOTAL_SAMPLES=$(jq -r '.summary.totalSamples' data/validation/latest-validation-summary.json)
        
        echo "âœ… æ•°æ®éªŒè¯é€šè¿‡ï¼"
        echo "ğŸ“Š å‡†ç¡®ç‡: $(echo "scale=1; $ACCURACY * 100" | bc)%"
        echo "ğŸ¯ æ ·æœ¬æ•°: $TOTAL_SAMPLES"
        echo "ğŸ•’ éªŒè¯æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" 