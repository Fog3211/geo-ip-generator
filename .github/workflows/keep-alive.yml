name: Keep Render App Alive

on:
  schedule:
    # æ¯ 14 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ Render å…è´¹ç‰ˆä¼‘çœ 
    # Render é€šå¸¸åœ¨ 15 åˆ†é’Ÿä¸æ´»è·ƒåä¼‘çœ 
    - cron: '*/14 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping deployed app
        run: |
          echo "Pinging app to prevent Render from sleeping..."
          
          # ä½¿ç”¨ä½ çš„ Render åº”ç”¨ URL
          APP_URL="${{ secrets.RENDER_APP_URL || 'https://ipregion.onrender.com' }}"
          
          # 1. è¯·æ±‚å‰ç«¯ä¸»é¡µé¢
          echo "ğŸ  Pinging frontend homepage..."
          frontend_response=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" || echo "000")
          
          if [ "$frontend_response" -eq 200 ] || [ "$frontend_response" -eq 304 ]; then
            echo "âœ… Frontend is alive! HTTP status: $frontend_response"
          else
            echo "âš ï¸  Frontend responded with status: $frontend_response"
          fi
          
          # 2. è¯·æ±‚å¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ¥ Pinging health check endpoint..."
          health_response=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/health" || echo "000")
          
          if [ "$health_response" -eq 200 ] || [ "$health_response" -eq 304 ]; then
            echo "âœ… Health check is alive! HTTP status: $health_response"
          else
            echo "âš ï¸  Health check responded with status: $health_response"
          fi
          
          # 3. æ±‡æ€»ç»“æœ
          if ([ "$frontend_response" -eq 200 ] || [ "$frontend_response" -eq 304 ]) && ([ "$health_response" -eq 200 ] || [ "$health_response" -eq 304 ]); then
            echo "ğŸ‰ Both frontend and backend are fully operational!"
          elif [ "$frontend_response" -eq 200 ] || [ "$frontend_response" -eq 304 ]; then
            echo "ğŸŸ¡ Frontend is working, but health check failed"
          elif [ "$health_response" -eq 200 ] || [ "$health_response" -eq 304 ]; then
            echo "ğŸŸ¡ Health check is working, but frontend failed"
          else
            echo "ğŸ”´ Both frontend and health check failed"
          fi
          
          echo "Keep-alive ping completed at $(date)"
      
      - name: Log activity
        run: |
          echo "Keep-alive job executed successfully"
          echo "Next scheduled run: $(date -d '+14 minutes')" 