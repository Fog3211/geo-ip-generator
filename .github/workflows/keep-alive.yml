name: Keep Render App Alive

on:
  schedule:
    # Run every 13 minutes to keep within Render free tier idle window
    - cron: '*/13 * * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: keep-alive-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ping:
    runs-on: ubuntu-latest
    env:
      # Comma-separated list of URLs to ping (supports multiple Render services / custom domains)
      APP_URLS: ${{ secrets.RENDER_APP_URLS || vars.RENDER_APP_URLS || secrets.RENDER_APP_URL || 'https://ipregion.onrender.com' }}
    steps:
      - name: Show target URLs
        run: |
          echo "Targets: $APP_URLS"

      - name: Ping all targets with retry
        run: |
          IFS=',' read -ra URLS <<< "$APP_URLS"
          UA="GeoIP-KeepAlive/1.0 (GitHub Actions)"
          OK_COUNT=0
          for raw in "${URLS[@]}"; do
            url=$(echo "$raw" | xargs)
            if [ -z "$url" ]; then continue; fi
            echo "\n=== Pinging $url ==="
            # homepage
            for i in 1 2 3; do
              code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: $UA" -H "Cache-Control: no-cache" "$url" || echo "000")
              echo "Attempt $i -> homepage: HTTP $code"
              [ "$code" = "200" ] || [ "$code" = "304" ] && break
              sleep 2
            done
            # health
            for i in 1 2 3; do
              hcode=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: $UA" -H "Cache-Control: no-cache" "$url/api/health" || echo "000")
              echo "Attempt $i -> /api/health: HTTP $hcode"
              [ "$hcode" = "200" ] || [ "$hcode" = "304" ] && break
              sleep 2
            done
            if { [ "$code" = "200" ] || [ "$code" = "304" ]; } && { [ "$hcode" = "200" ] || [ "$hcode" = "304" ]; }; then
              OK_COUNT=$((OK_COUNT+1))
            fi
          done
          echo "OK targets: $OK_COUNT / ${#URLS[@]}"
          if [ $OK_COUNT -eq 0 ]; then
            echo "::warning::All keep-alive checks failed. Verify RENDER_APP_URLS (secrets/variables) and service status."
          fi

      - name: Log activity
        run: |
          echo "Keep-alive job executed at $(date -u)"
          echo "Next scheduled run in ~13 minutes (GitHub Actions cron, UTC)"